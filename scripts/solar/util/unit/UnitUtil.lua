local ____lualib = require("lualib_bundle")
local __TS__Class = ____lualib.__TS__Class
local __TS__SourceMapTraceBack = ____lualib.__TS__SourceMapTraceBack
__TS__SourceMapTraceBack(debug.getinfo(1).short_src, {["6"] = 2,["7"] = 2,["8"] = 3,["9"] = 3,["10"] = 4,["11"] = 4,["12"] = 6,["13"] = 8,["14"] = 8,["15"] = 8,["17"] = 8,["18"] = 15,["19"] = 22,["20"] = 23,["21"] = 24,["23"] = 26,["24"] = 27,["26"] = 29,["27"] = 30,["29"] = 32,["30"] = 33,["32"] = 35,["33"] = 36,["35"] = 38,["36"] = 15,["37"] = 48,["38"] = 49,["40"] = 51,["41"] = 51,["42"] = 52,["43"] = 53,["44"] = 54,["46"] = 51,["49"] = 57,["50"] = 48,["51"] = 66,["53"] = 67,["54"] = 67,["55"] = 68,["56"] = 69,["57"] = 70,["59"] = 67,["62"] = 73,["63"] = 66,["64"] = 84,["65"] = 85,["68"] = 89,["69"] = 90,["70"] = 91,["72"] = 93,["73"] = 94,["74"] = 96,["75"] = 97,["76"] = 98,["78"] = 100,["79"] = 101,["80"] = 103,["81"] = 104,["82"] = 105,["84"] = 107,["85"] = 108,["86"] = 84,["87"] = 119,["88"] = 120,["91"] = 123,["92"] = 125,["93"] = 126,["94"] = 127,["96"] = 129,["97"] = 130,["98"] = 131,["99"] = 133,["100"] = 134,["101"] = 135,["103"] = 137,["104"] = 138,["105"] = 139,["106"] = 141,["107"] = 142,["108"] = 143,["110"] = 145,["111"] = 146,["112"] = 147,["113"] = 119,["114"] = 155,["115"] = 155,["116"] = 155,["118"] = 156,["119"] = 157,["120"] = 158,["121"] = 159,["122"] = 160,["124"] = 162,["125"] = 163,["126"] = 164,["127"] = 165,["128"] = 166,["129"] = 167,["130"] = 168,["131"] = 155,["132"] = 171,["133"] = 172,["134"] = 171,["135"] = 178,["136"] = 178,["137"] = 178,["139"] = 179,["140"] = 180,["141"] = 181,["142"] = 182,["143"] = 183,["144"] = 184,["145"] = 185,["146"] = 186,["147"] = 187,["148"] = 188,["149"] = 178,["150"] = 191,["151"] = 192,["152"] = 191,["153"] = 198,["154"] = 198,["155"] = 198,["157"] = 199,["158"] = 200,["159"] = 201,["160"] = 202,["161"] = 198,["162"] = 208,["163"] = 208,["164"] = 208,["166"] = 209,["167"] = 210,["168"] = 211,["169"] = 212,["170"] = 208,["171"] = 218,["172"] = 218,["173"] = 218,["175"] = 219,["176"] = 220,["177"] = 221,["178"] = 222,["179"] = 218,["180"] = 228,["181"] = 228,["182"] = 228,["184"] = 230,["185"] = 231,["186"] = 231,["187"] = 231,["188"] = 231,["189"] = 231,["190"] = 231,["191"] = 228,["192"] = 238,["193"] = 239,["194"] = 238,["195"] = 245,["196"] = 245,["197"] = 245,["199"] = 247,["200"] = 248,["201"] = 249,["203"] = 251,["204"] = 251,["205"] = 251,["206"] = 251,["207"] = 251,["208"] = 251,["209"] = 245,["210"] = 258,["211"] = 259,["212"] = 258,["213"] = 265,["214"] = 265,["215"] = 265,["217"] = 267,["218"] = 268,["219"] = 270,["221"] = 272,["222"] = 272,["223"] = 272,["224"] = 272,["225"] = 272,["226"] = 272,["227"] = 265,["228"] = 279,["229"] = 280,["230"] = 279,["231"] = 289,["232"] = 290,["233"] = 291,["234"] = 292,["235"] = 293,["236"] = 289,["237"] = 299,["238"] = 299,["239"] = 299,["241"] = 300,["242"] = 301,["243"] = 302,["244"] = 303,["245"] = 299,["246"] = 310,["247"] = 311,["248"] = 312,["250"] = 314,["251"] = 310,["252"] = 320,["253"] = 320,["254"] = 320,["256"] = 321,["257"] = 322,["258"] = 323,["259"] = 324,["260"] = 320,["261"] = 331,["262"] = 332,["263"] = 333,["265"] = 335,["266"] = 331,["267"] = 341,["268"] = 341,["269"] = 341,["271"] = 342,["272"] = 343,["273"] = 344,["274"] = 345,["275"] = 341,["276"] = 352,["277"] = 353,["278"] = 354,["280"] = 356,["281"] = 352,["282"] = 369,["283"] = 369,["284"] = 369,["286"] = 370,["287"] = 371,["288"] = 372,["289"] = 373,["290"] = 374,["291"] = 375,["293"] = 377,["295"] = 379,["296"] = 380,["297"] = 369,["298"] = 389,["299"] = 390,["300"] = 391,["301"] = 392,["303"] = 394,["304"] = 395,["305"] = 396,["306"] = 396,["307"] = 396,["309"] = 396,["311"] = 398,["312"] = 389,["313"] = 410,["314"] = 411,["315"] = 412,["317"] = 414,["318"] = 415,["319"] = 416,["320"] = 417,["321"] = 410,["322"] = 428,["323"] = 429,["324"] = 430,["325"] = 431,["326"] = 432,["327"] = 433,["328"] = 434,["329"] = 435,["330"] = 436,["332"] = 438,["333"] = 439,["334"] = 441,["335"] = 443,["336"] = 443,["337"] = 443,["338"] = 443,["339"] = 443,["340"] = 443,["341"] = 444,["342"] = 444,["343"] = 444,["344"] = 444,["345"] = 444,["346"] = 444,["347"] = 445,["348"] = 445,["349"] = 445,["350"] = 445,["351"] = 445,["352"] = 445,["353"] = 447,["354"] = 448,["356"] = 452,["357"] = 453,["360"] = 458,["361"] = 459,["362"] = 460,["364"] = 462,["365"] = 428,["366"] = 8});
local ____exports = {}
local ____DataBase = require("solar.common.DataBase")
local DataBase = ____DataBase.default
local ____MathUtil = require("solar.util.math.MathUtil")
local MathUtil = ____MathUtil.default
local ____UnitStateUtil = require("solar.util.unit.UnitStateUtil")
local UnitStateUtil = ____UnitStateUtil.default
local BaseAttributeMax = 10000000
____exports.default = __TS__Class()
local UnitUtil = ____exports.default
UnitUtil.name = "UnitUtil"
function UnitUtil.prototype.____constructor(self)
end
function UnitUtil.calculateDamageByPropertySet(unitHandle, dmgPropertySet)
    local damage = 0
    if dmgPropertySet.strDamageRate then
        damage = GetHeroStr(unitHandle, true) * dmgPropertySet.strDamageRate + damage
    end
    if dmgPropertySet.agiDamageRate then
        damage = GetHeroAgi(unitHandle, true) * dmgPropertySet.agiDamageRate + damage
    end
    if dmgPropertySet.intDamageRate then
        damage = GetHeroInt(unitHandle, true) * dmgPropertySet.intDamageRate + damage
    end
    if dmgPropertySet.hpDamageRate then
        damage = GetUnitState(unitHandle, UNIT_STATE_LIFE) * dmgPropertySet.hpDamageRate + damage
    end
    if dmgPropertySet.manaDamageRate then
        damage = GetUnitState(unitHandle, UNIT_STATE_MANA) * dmgPropertySet.hpDamageRate + damage
    end
    return damage
end
function UnitUtil.GetInventoryIndexOfItemType(unitHandle, id)
    local idint = FourCC(id)
    do
        local i = 0
        while i < 6 do
            local indexItem = UnitItemInSlot(unitHandle, i)
            if indexItem ~= nil and GetItemTypeId(indexItem) == idint then
                return i + 1
            end
            i = i + 1
        end
    end
    return 0
end
function UnitUtil.GetInventoryOfItemType(unitHandle, idint)
    do
        local i = 0
        while i < 6 do
            local indexItem = UnitItemInSlot(unitHandle, i)
            if indexItem ~= nil and GetItemTypeId(indexItem) == idint then
                return indexItem
            end
            i = i + 1
        end
    end
    return nil
end
function UnitUtil.addHeroProperty(unit, key, addNum)
    if not unit:isHero() then
        return
    end
    local baseStr = unit.strength
    if unit.solarData["UnitUtil_addHeroProperty_strength_" .. key] then
        baseStr = baseStr - unit.solarData["UnitUtil_addHeroProperty_strength_" .. key]
    end
    unit.solarData["UnitUtil_addHeroProperty_strength_" .. key] = addNum
    unit.strength = baseStr + addNum
    local baseAgi = unit.agility
    if unit.solarData["UnitUtil_addHeroProperty_agility_" .. key] then
        baseAgi = baseAgi - unit.solarData["UnitUtil_addHeroProperty_agility_" .. key]
    end
    unit.solarData["UnitUtil_addHeroProperty_agility_" .. key] = addNum
    unit.agility = baseAgi + addNum
    local baseInt = unit.intelligence
    if unit.solarData["UnitUtil_addHeroProperty_intelligence_" .. key] then
        baseInt = baseInt - unit.solarData["UnitUtil_addHeroProperty_intelligence_" .. key]
    end
    unit.solarData["UnitUtil_addHeroProperty_intelligence_" .. key] = addNum
    unit.intelligence = baseInt + addNum
end
function UnitUtil.addHeroPropertyByRate(unit, key, addRate)
    if not unit:isHero() then
        return
    end
    local addNum = 0
    local baseStr = unit.strength
    if unit.solarData["UnitUtil_addHeroPropertyByRate_strength_" .. key] then
        baseStr = baseStr - unit.solarData["UnitUtil_addHeroPropertyByRate_strength_" .. key]
    end
    addNum = baseStr * addRate
    unit.solarData["UnitUtil_addHeroPropertyByRate_strength_" .. key] = addNum
    unit.strength = baseStr + addNum
    local baseAgi = unit.agility
    if unit.solarData["UnitUtil_addHeroPropertyByRate_agility_" .. key] then
        baseAgi = baseAgi - unit.solarData["UnitUtil_addHeroPropertyByRate_agility_" .. key]
    end
    addNum = baseAgi * addRate
    unit.solarData["UnitUtil_addHeroPropertyByRate_agility_" .. key] = addNum
    unit.agility = baseAgi + addNum
    local baseInt = unit.intelligence
    if unit.solarData["UnitUtil_addHeroPropertyByRate_intelligence_" .. key] then
        baseInt = baseInt - unit.solarData["UnitUtil_addHeroPropertyByRate_intelligence_" .. key]
    end
    addNum = baseInt * addRate
    unit.solarData["UnitUtil_addHeroPropertyByRate_intelligence_" .. key] = addNum
    unit.intelligence = baseInt + addNum
end
function UnitUtil.setExtraMana(unitHandle, val, key)
    if key == nil then
        key = "base"
    end
    local nowValue = GetUnitState(unitHandle, UNIT_STATE_MANA)
    local maxValue = GetUnitState(unitHandle, UNIT_STATE_MAX_MANA)
    local bfp = 1
    if maxValue > 0 then
        bfp = nowValue / maxValue
    end
    local oldExtra = ____exports.default.getExtraMana(unitHandle)
    val = ____exports.default.extraValueSum(unitHandle, "_SLExt_Mana", val, key)
    local add = val - oldExtra
    maxValue = maxValue + add
    nowValue = bfp * maxValue
    SetUnitState(unitHandle, UNIT_STATE_MAX_MANA, maxValue)
    SetUnitState(unitHandle, UNIT_STATE_MANA, nowValue)
end
function UnitUtil.getExtraMana(unitHandle, key)
    return ____exports.default.getExtraValue(unitHandle, "_SLExt_Mana", key)
end
function UnitUtil.setExtraHp(unitHandle, val, key)
    if key == nil then
        key = "base"
    end
    local nowValue = GetUnitState(unitHandle, UNIT_STATE_LIFE)
    local maxValue = GetUnitState(unitHandle, UNIT_STATE_MAX_LIFE)
    local bfp = nowValue / maxValue
    local oldExtra = ____exports.default.getExtraHp(unitHandle)
    val = ____exports.default.extraValueSum(unitHandle, "_SLExt_Hp", val, key)
    local add = val - oldExtra
    maxValue = maxValue + add
    nowValue = bfp * maxValue
    SetUnitState(unitHandle, UNIT_STATE_MAX_LIFE, maxValue)
    SetUnitState(unitHandle, UNIT_STATE_LIFE, nowValue)
end
function UnitUtil.getExtraHp(unitHandle, key)
    return ____exports.default.getExtraValue(unitHandle, "_SLExt_Hp", key)
end
function UnitUtil.setExtraDamageCool(unitHandle, val, key)
    if key == nil then
        key = "base"
    end
    local oldExtra = ____exports.default.getExtraValue(unitHandle, "_SLExt_DamageCool")
    val = ____exports.default.extraValueSum(unitHandle, "_SLExt_DamageCool", val, key)
    local add = val - oldExtra
    UnitStateUtil:addDamageCool(unitHandle, add)
end
function UnitUtil.setExtraDamageRange(unitHandle, val, key)
    if key == nil then
        key = "base"
    end
    local oldExtra = ____exports.default.getExtraValue(unitHandle, "_SLExt_DamageRange")
    val = ____exports.default.extraValueSum(unitHandle, "_SLExt_DamageRange", val, key)
    local add = val - oldExtra
    UnitStateUtil:addDamageRange(unitHandle, add)
end
function UnitUtil.setExtraMoveSpeed(unitHandle, val, key)
    if key == nil then
        key = "base"
    end
    local oldExtra = ____exports.default.getExtraValue(unitHandle, "_SLExt_MoveSpeed")
    val = ____exports.default.extraValueSum(unitHandle, "_SLExt_MoveSpeed", val, key)
    local add = val - oldExtra
    UnitStateUtil:addMoveSpeed(unitHandle, add)
end
function UnitUtil.setExtraAttackSpd(unitHandle, val, key)
    if key == nil then
        key = "base"
    end
    val = ____exports.default.extraValueSum(unitHandle, "_SLExt_AttackSpd", val, key)
    ____exports.default.refreshUnitAbilityData(
        unitHandle,
        FourCC("AIs2"),
        ABILITY_DATA_DATA_A,
        val
    )
end
function UnitUtil.getExtraAttackSpd(unitHandle)
    return ____exports.default.getExtraValue(unitHandle, "_SLExt_AttackSpd")
end
function UnitUtil.setExtraAttack(unitHandle, val, key)
    if key == nil then
        key = "base"
    end
    val = ____exports.default.extraValueSum(unitHandle, "_SLExt_Attack", val, key)
    if isBigAttributeMode then
        val = MathUtil.min(val, BaseAttributeMax)
    end
    ____exports.default.refreshUnitAbilityData(
        unitHandle,
        FourCC("AItg"),
        108,
        val
    )
end
function UnitUtil.getExtraAttack(unitHandle)
    return ____exports.default.getExtraValue(unitHandle, "_SLExt_Attack")
end
function UnitUtil.setExtraDef(unitHandle, val, key)
    if key == nil then
        key = "base"
    end
    val = ____exports.default.extraValueSum(unitHandle, "_SLExt_Def", val, key)
    if isBigAttributeMode then
        val = MathUtil.min(val, BaseAttributeMax)
    end
    ____exports.default.refreshUnitAbilityData(
        unitHandle,
        FourCC("AId1"),
        108,
        val
    )
end
function UnitUtil.getExtraDef(unitHandle)
    return ____exports.default.getExtraValue(unitHandle, "_SLExt_Def")
end
function UnitUtil.setExtraStrAgiInt(unitHandle, key, str, agi, int)
    local str_val = ____exports.default.extraValueSum(unitHandle, "_SLExt_Str", str, key)
    local agi_val = ____exports.default.extraValueSum(unitHandle, "_SLExt_Agi", agi, key)
    local int_val = ____exports.default.extraValueSum(unitHandle, "_SLExt_Int", int, key)
    ____exports.default.refreshUnitAamkData(unitHandle, str_val, agi_val, int_val)
end
function UnitUtil.setExtraStr(unitHandle, val, key)
    if key == nil then
        key = "base"
    end
    local str_val = ____exports.default.extraValueSum(unitHandle, "_SLExt_Str", val, key)
    local agi_val = ____exports.default.getExtraAgi(unitHandle)
    local int_val = ____exports.default.getExtraInt(unitHandle)
    ____exports.default.refreshUnitAamkData(unitHandle, str_val, agi_val, int_val)
end
function UnitUtil.getExtraStr(unitHandle, key)
    if key then
        return ____exports.default.getExtraValue(unitHandle, "_SLExt_Str", key)
    end
    return ____exports.default.getExtraValue(unitHandle, "_SLExt_Str")
end
function UnitUtil.setExtraAgi(unitHandle, val, key)
    if key == nil then
        key = "base"
    end
    local str_val = ____exports.default.getExtraStr(unitHandle)
    local agi_val = ____exports.default.extraValueSum(unitHandle, "_SLExt_Agi", val, key)
    local int_val = ____exports.default.getExtraInt(unitHandle)
    ____exports.default.refreshUnitAamkData(unitHandle, str_val, agi_val, int_val)
end
function UnitUtil.getExtraAgi(unitHandle, key)
    if key then
        return ____exports.default.getExtraValue(unitHandle, "_SLExt_Agi", key)
    end
    return ____exports.default.getExtraValue(unitHandle, "_SLExt_Agi")
end
function UnitUtil.setExtraInt(unitHandle, val, key)
    if key == nil then
        key = "base"
    end
    local str_val = ____exports.default.getExtraStr(unitHandle)
    local agi_val = ____exports.default.getExtraAgi(unitHandle)
    local int_val = ____exports.default.extraValueSum(unitHandle, "_SLExt_Int", val, key)
    ____exports.default.refreshUnitAamkData(unitHandle, str_val, agi_val, int_val)
end
function UnitUtil.getExtraInt(unitHandle, key)
    if key then
        return ____exports.default.getExtraValue(unitHandle, "_SLExt_Int", key)
    end
    return ____exports.default.getExtraValue(unitHandle, "_SLExt_Int")
end
function UnitUtil.extraValueSum(unitHandle, ____type, val, key)
    if key == nil then
        key = "base"
    end
    local solarData = DataBase:getUnitSolarData(unitHandle)
    local extraData = solarData[____type]
    if val then
        if not extraData then
            extraData = {}
            solarData[____type] = extraData
        end
        extraData[key] = val
    end
    local count = MathUtil.sum(extraData)
    return count
end
function UnitUtil.getExtraValue(unitHandle, ____type, key)
    local solarData = DataBase:getUnitSolarData(unitHandle, false)
    if not solarData then
        return 0
    end
    local extraData = solarData[____type]
    if key then
        local ____extraData_key_0 = extraData
        if ____extraData_key_0 ~= nil then
            ____extraData_key_0 = ____extraData_key_0[key]
        end
        return ____extraData_key_0 or 0
    end
    return MathUtil.sum(extraData)
end
function UnitUtil.refreshUnitAbilityData(unitHandle, abilcode, data_type, value)
    if GetUnitAbilityLevel(unitHandle, abilcode) <= 0 then
        UnitAddAbility(unitHandle, abilcode)
    end
    local ability = EXGetUnitAbility(unitHandle, abilcode)
    IncUnitAbilityLevel(unitHandle, abilcode)
    EXSetAbilityDataReal(ability, 1, data_type, value)
    DecUnitAbilityLevel(unitHandle, abilcode)
end
function UnitUtil.refreshUnitAamkData(unitHandle, str, agi, int)
    local abilcode = FourCC("Aamk")
    if GetUnitAbilityLevel(unitHandle, abilcode) <= 0 then
        UnitAddAbility(unitHandle, abilcode)
        local ability = EXGetUnitAbility(unitHandle, abilcode)
        EXSetAbilityDataReal(ability, 1, ABILITY_DATA_DATA_D, 1)
        EXSetAbilityDataReal(ability, 1, ABILITY_DATA_DATA_A, 0)
        EXSetAbilityDataReal(ability, 1, ABILITY_DATA_DATA_B, 0)
        EXSetAbilityDataReal(ability, 1, ABILITY_DATA_DATA_C, 0)
    end
    local ability = EXGetUnitAbility(unitHandle, abilcode)
    IncUnitAbilityLevel(unitHandle, abilcode)
    if isBigAttributeMode then
        EXSetAbilityDataReal(
            ability,
            1,
            ABILITY_DATA_DATA_A,
            MathUtil.min(agi, BaseAttributeMax)
        )
        EXSetAbilityDataReal(
            ability,
            1,
            ABILITY_DATA_DATA_B,
            MathUtil.min(int, BaseAttributeMax)
        )
        EXSetAbilityDataReal(
            ability,
            1,
            ABILITY_DATA_DATA_C,
            MathUtil.min(str, BaseAttributeMax)
        )
        if StrHpBonus > 0 and str > BaseAttributeMax then
            ____exports.default.setExtraHp(unitHandle, (str - BaseAttributeMax) * StrHpBonus, "_SL_refreshUnitAamkData")
        end
        if IntManaBonus > 0 and int > BaseAttributeMax then
            ____exports.default.setExtraMana(unitHandle, (int - BaseAttributeMax) * IntManaBonus, "_SL_refreshUnitAamkData")
        end
    else
        EXSetAbilityDataReal(ability, 1, ABILITY_DATA_DATA_A, agi)
        EXSetAbilityDataReal(ability, 1, ABILITY_DATA_DATA_B, int)
        EXSetAbilityDataReal(ability, 1, ABILITY_DATA_DATA_C, str)
    end
    DecUnitAbilityLevel(unitHandle, abilcode)
end
____exports.default = UnitUtil
return ____exports
