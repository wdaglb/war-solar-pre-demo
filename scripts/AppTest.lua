local ____lualib = require("lualib_bundle")
local __TS__Class = ____lualib.__TS__Class
local __TS__New = ____lualib.__TS__New
local __TS__ObjectAssign = ____lualib.__TS__ObjectAssign
local __TS__SourceMapTraceBack = ____lualib.__TS__SourceMapTraceBack
__TS__SourceMapTraceBack(debug.getinfo(1).short_src, {["8"] = 1,["9"] = 1,["10"] = 2,["11"] = 2,["12"] = 3,["13"] = 3,["14"] = 4,["15"] = 4,["16"] = 5,["17"] = 5,["18"] = 6,["19"] = 6,["20"] = 6,["21"] = 7,["22"] = 7,["23"] = 8,["24"] = 8,["25"] = 9,["26"] = 9,["27"] = 10,["28"] = 10,["29"] = 11,["30"] = 11,["31"] = 12,["32"] = 12,["33"] = 13,["34"] = 13,["35"] = 14,["36"] = 14,["37"] = 15,["38"] = 15,["39"] = 16,["40"] = 16,["41"] = 19,["42"] = 19,["43"] = 19,["45"] = 22,["46"] = 23,["47"] = 23,["48"] = 23,["49"] = 24,["50"] = 23,["51"] = 23,["52"] = 26,["53"] = 26,["54"] = 26,["55"] = 27,["56"] = 26,["57"] = 26,["58"] = 31,["59"] = 33,["60"] = 33,["61"] = 34,["64"] = 38,["65"] = 39,["66"] = 40,["68"] = 42,["69"] = 42,["70"] = 42,["71"] = 42,["72"] = 42,["73"] = 42,["74"] = 42,["75"] = 33,["77"] = 21,["78"] = 48,["79"] = 49,["80"] = 50,["81"] = 48,["82"] = 54,["83"] = 55,["84"] = 56,["85"] = 55,["86"] = 58,["87"] = 59,["88"] = 60,["89"] = 58,["90"] = 62,["91"] = 63,["92"] = 64,["93"] = 62,["94"] = 66,["95"] = 66,["96"] = 66,["97"] = 67,["98"] = 66,["99"] = 66,["100"] = 69,["101"] = 70,["102"] = 71,["103"] = 72,["104"] = 69,["105"] = 75,["106"] = 76,["107"] = 77,["108"] = 78,["109"] = 79,["110"] = 75,["111"] = 54,["112"] = 87,["113"] = 88,["114"] = 88,["115"] = 88,["116"] = 89,["117"] = 90,["118"] = 90,["119"] = 90,["120"] = 90,["121"] = 90,["122"] = 90,["123"] = 90,["124"] = 90,["125"] = 91,["126"] = 91,["127"] = 91,["128"] = 91,["129"] = 91,["130"] = 91,["131"] = 91,["132"] = 91,["133"] = 92,["134"] = 93,["135"] = 94,["136"] = 88,["137"] = 88,["138"] = 98,["139"] = 100,["140"] = 100,["141"] = 100,["142"] = 101,["143"] = 100,["144"] = 100,["145"] = 104,["146"] = 106,["147"] = 106,["148"] = 106,["149"] = 107,["150"] = 107,["151"] = 107,["152"] = 108,["153"] = 109,["154"] = 107,["155"] = 107,["156"] = 112,["157"] = 112,["158"] = 112,["159"] = 113,["160"] = 114,["161"] = 112,["162"] = 112,["163"] = 106,["164"] = 106,["165"] = 87,["166"] = 119,["167"] = 120,["168"] = 120,["169"] = 120,["170"] = 121,["171"] = 122,["172"] = 122,["173"] = 122,["174"] = 122,["175"] = 122,["176"] = 122,["177"] = 122,["178"] = 122,["179"] = 123,["180"] = 123,["181"] = 123,["182"] = 124,["183"] = 126,["184"] = 127,["185"] = 128,["187"] = 130,["188"] = 131,["190"] = 133,["191"] = 134,["192"] = 135,["193"] = 136,["194"] = 137,["195"] = 139,["196"] = 140,["197"] = 141,["198"] = 141,["199"] = 141,["200"] = 141,["201"] = 146,["202"] = 146,["203"] = 146,["204"] = 146,["205"] = 146,["206"] = 146,["207"] = 146,["208"] = 146,["209"] = 146,["210"] = 146,["211"] = 146,["212"] = 146,["213"] = 158,["214"] = 159,["215"] = 141,["216"] = 162,["217"] = 163,["218"] = 123,["219"] = 123,["220"] = 120,["221"] = 120,["222"] = 119,["223"] = 169,["224"] = 170,["225"] = 171,["226"] = 172,["227"] = 173,["228"] = 174,["229"] = 175,["230"] = 176,["231"] = 176,["232"] = 176,["233"] = 176,["234"] = 176,["235"] = 176,["236"] = 176,["237"] = 175,["238"] = 180,["239"] = 180,["240"] = 180,["241"] = 181,["242"] = 181,["243"] = 181,["244"] = 181,["245"] = 181,["246"] = 181,["247"] = 181,["248"] = 180,["249"] = 180,["250"] = 184,["251"] = 185,["252"] = 184,["253"] = 169,["254"] = 190,["255"] = 191,["256"] = 192,["257"] = 193,["258"] = 194,["259"] = 195,["260"] = 196,["261"] = 198,["262"] = 199,["263"] = 199,["264"] = 199,["265"] = 199,["266"] = 199,["267"] = 199,["268"] = 199,["269"] = 193,["270"] = 201,["271"] = 202,["272"] = 203,["273"] = 204,["274"] = 205,["275"] = 208,["276"] = 202,["277"] = 190,["278"] = 212,["279"] = 215,["280"] = 216,["281"] = 216,["282"] = 216,["283"] = 216,["284"] = 217,["285"] = 218,["286"] = 218,["287"] = 218,["288"] = 218,["289"] = 218,["290"] = 218,["291"] = 218,["292"] = 219,["293"] = 219,["294"] = 219,["295"] = 219,["296"] = 219,["297"] = 220,["298"] = 220,["299"] = 220,["300"] = 219,["301"] = 219,["303"] = 222,["304"] = 222,["305"] = 222,["306"] = 222,["307"] = 222,["308"] = 224,["309"] = 224,["310"] = 224,["311"] = 224,["312"] = 224,["314"] = 212,["315"] = 230,["316"] = 231,["317"] = 231,["318"] = 231,["319"] = 233,["320"] = 234,["321"] = 236,["322"] = 237,["323"] = 238,["324"] = 239,["325"] = 240,["326"] = 241,["327"] = 231,["328"] = 231,["329"] = 230,["330"] = 19});
local ____exports = {}
local ____DebugUtil = require("solar.util.debug.DebugUtil")
local DebugUtil = ____DebugUtil.default
local ____BaseUtil = require("solar.util.BaseUtil")
local BaseUtil = ____BaseUtil.default
local ____unit = require("solar.w3ts.handles.unit")
local Unit = ____unit.Unit
local ____Gui = require("Gui")
local Gui = ____Gui.default
local ____Log = require("solar.common.Log")
local Log = ____Log.default
local ____tween = require("solar.lib.tween.index")
local Easing = ____tween.Easing
local Tween = ____tween.Tween
local ____SyncUtil = require("solar.util.net.SyncUtil")
local SyncUtil = ____SyncUtil.default
local ____frame = require("solar.w3ts.handles.frame")
local Frame = ____frame.Frame
local ____ArchiveUtil = require("solar.util.archive.ArchiveUtil")
local ArchiveUtil = ____ArchiveUtil.default
local ____AsyncUtil = require("solar.util.net.AsyncUtil")
local AsyncUtil = ____AsyncUtil.default
local ____CameraUtil = require("solar.util.game.CameraUtil")
local CameraUtil = ____CameraUtil.default
local ____InterpolationUtil = require("solar.util.math.InterpolationUtil")
local InterpolationUtil = ____InterpolationUtil.default
local ____Vector3 = require("solar.lib.mod.Vector3")
local Vector3 = ____Vector3.default
local ____SolarDamageState = require("solar.atrribute.SolarDamageState")
local SolarDamageState = ____SolarDamageState.default
local ____TextTagUtil = require("solar.util.text.TextTagUtil")
local TextTagUtil = ____TextTagUtil.default
local ____DebugCheckSyncUtil = require("solar.util.debug.DebugCheckSyncUtil")
local DebugCheckSyncUtil = ____DebugCheckSyncUtil.default
____exports.default = __TS__Class()
local AppTest = ____exports.default
AppTest.name = "AppTest"
function AppTest.prototype.____constructor(self)
    if isDebug then
        se:playerChat(
            "se",
            function()
                self:seTest()
            end
        )
        se:playerChat(
            "cs",
            function()
                DebugCheckSyncUtil.start()
            end
        )
        self:solarTest()
        local ____SolarDamageState_config_damageEventHandlers_0 = SolarDamageState.config.damageEventHandlers
        ____SolarDamageState_config_damageEventHandlers_0[#____SolarDamageState_config_damageEventHandlers_0 + 1] = function(____, event)
            if not event.isCritical then
                return
            end
            local tag = "暴击:"
            if not event.isPhysical then
                tag = "法术" .. tag
            end
            TextTagUtil.textOnUnit(
                event.unit0,
                tag .. tostring(math.floor(event.resultDamage)),
                200,
                20,
                200
            )
        end
    end
end
function AppTest.prototype.onUnitAttacked(self, triggerUnit, attacker)
    BJDebugMsg("触发单位=" .. GetUnitName(triggerUnit))
    BJDebugMsg("攻击单位=" .. GetUnitName(attacker))
end
function AppTest.prototype.seTest(self)
    se:unitAttacked(function(...)
        self:onUnitAttacked(...)
    end)
    se:unitAttacked(function(triggerUnit, attacker)
        BJDebugMsg("被攻击单位2222=" .. GetUnitName(triggerUnit))
        BJDebugMsg("攻击单位2222=" .. GetUnitName(attacker))
    end)
    se:unitDeath(function(triggerUnit, xs)
        BJDebugMsg("死亡单位=" .. GetUnitName(triggerUnit))
        BJDebugMsg("凶手单位=" .. GetUnitName(xs))
    end)
    se:enterRect(
        nil,
        function(u)
            BJDebugMsg("进入区域了=" .. GetUnitName(u))
        end
    )
    se:unitDamaged(function(t, u, d)
        BJDebugMsg("受伤单位=" .. GetUnitName(t))
        BJDebugMsg("伤害来源=" .. GetUnitName(u))
        BJDebugMsg("伤害值=" .. tostring(d))
    end)
    se:unitPickupItem(function(triggerUnit, item, itemIdStr)
        BJDebugMsg("拾取物品的单位=" .. GetUnitName(triggerUnit))
        BJDebugMsg("物品名称=" .. GetItemName(item))
        BJDebugMsg("物品id=" .. itemIdStr)
        DisableTrigger(GetTriggeringTrigger())
    end)
end
function AppTest.prototype.solarTest(self)
    se:playerChat(
        "1",
        function()
            DebugUtil.showText(tostring(BaseUtil.getGameTime()) .. "")
            local unit = __TS__New(
                Unit,
                0,
                "hpea",
                0,
                0,
                0
            )
            SetUnitState(
                unit.handle,
                ConvertUnitState(18),
                500 + GetUnitState(
                    GetTriggerUnit(),
                    ConvertUnitState(18)
                ) * 100
            )
            print_r(handledef(unit.handle).reference)
            DebugUtil.printLocalVars()
            self:uiTest()
        end
    )
    self:httpJsonTest()
    DebugUtil.onChat(
        "2",
        function()
            self:archiveTest()
        end
    )
    self:w2sTest()
    DebugUtil.onChat(
        "4",
        function()
            local sTimer = BaseUtil.onTimer(
                1,
                function(____, c)
                    BJDebugMsg("太阳计时器循环执行:" .. tostring(c))
                    return true
                end
            )
            BaseUtil.runLater(
                5,
                function()
                    BJDebugMsg("手动关闭太阳计时器循环执行:" .. tostring(sTimer))
                    sTimer:destroy()
                end
            )
        end
    )
end
function AppTest.prototype.w2sTest(self)
    se:playerChat(
        "3",
        function()
            DebugUtil.showText(tostring(BaseUtil.getGameTime()) .. "测试世界坐标转屏幕坐标")
            local unit = __TS__New(
                Unit,
                0,
                "Hamg",
                0,
                0,
                0
            )
            BaseUtil.onTimer(
                0.05,
                function(____, c)
                    local screenCoordinates = CameraUtil:getScreenCoordinates(unit.x, unit.y)
                    log.debug("sc=" .. JSON:stringify(screenCoordinates))
                    if screenCoordinates.x < 0 or screenCoordinates.x > 0.8 then
                        return true
                    end
                    if screenCoordinates.y < 0 or screenCoordinates.y > 0.6 then
                        return true
                    end
                    local frame = Frame:createBackDrop()
                    frame:setTexture("ReplaceableTextures\\Selection\\SelectionCircleSmall.blp")
                    frame:setSize(0.04, 0.04)
                    screenCoordinates.x = screenCoordinates.x - 0.02
                    frame:setAbsPoint(FRAMEPOINT_TOPLEFT, screenCoordinates.x, screenCoordinates.y)
                    local toX = 0
                    local toY = 0
                    local tween = __TS__New(
                        Tween,
                        __TS__ObjectAssign({}, screenCoordinates, {p = 0, s = 0.04})
                    ):to({x = toX, y = toY, p = 1, s = 0}, 2000):easing(Easing.Quadratic.Out):onUpdate(function(____, temp)
                        local position = InterpolationUtil:bezier(
                            temp.p,
                            __TS__New(Vector3, screenCoordinates.x, screenCoordinates.y),
                            __TS__New(Vector3, 0, 0),
                            __TS__New(Vector3, 0, 0.8),
                            __TS__New(Vector3, 0.6, 0.8),
                            __TS__New(Vector3, 0.6, 0),
                            __TS__New(Vector3, 0, 0),
                            __TS__New(Vector3, 0, 0.8),
                            __TS__New(Vector3, 0.6, 0.8),
                            __TS__New(Vector3, 0.6, 0)
                        )
                        frame:setAbsPoint(FRAMEPOINT_TOPLEFT, position.x, position.y)
                        frame:setSize(temp.s, temp.s)
                    end)
                    tween:start()
                    return true
                end
            )
        end
    )
end
function AppTest.prototype.uiTest(self)
    local frame = Frame:createTEXTBUTTON()
    frame:setText("测试Frame按钮")
    frame:addBackgroundImage("ReplaceableTextures\\Selection\\SelectionCircleSmall.blp")
    frame:setSize(0.1, 0.2)
    frame:setAbsPoint(FRAMEPOINT_BOTTOMLEFT, 0.1, 0.2)
    frame:setOnClick(function()
        DisplayTimedTextToPlayer(
            GetLocalPlayer(),
            0,
            0,
            20,
            "测试Frame按钮 点击了！"
        )
    end)
    SyncUtil.onSyncData(
        "gui_test",
        function(____, p)
            DisplayTimedTextToPlayer(
                GetLocalPlayer(),
                0,
                0,
                20,
                "接收到数据同步！触发的玩家为:" .. GetPlayerName(p)
            )
        end
    )
    AsyncUtil:run(function()
        __TS__New(Gui)
    end)
end
function AppTest.prototype.hookTest(self)
    print(log.path)
    local jassCreateUnit = CreateUnit
    _G.CreateUnit = function(id, unitid, x, y, face)
        local info = (((((("你创建了单位id:" .. tostring(GetPlayerId(id))) .. " unitid=") .. tostring(unitid)) .. " x,y=") .. tostring(x)) .. ",") .. tostring(y)
        print(info)
        log.info(info)
        Log.enable = false
        return jassCreateUnit(
            id,
            unitid,
            x,
            y,
            face
        )
    end
    local jassRemoveItem = RemoveItem
    _G.RemoveItem = function(whichItem)
        local info = (("移除了物品:" .. GetItemName(whichItem)) .. " handle=") .. tostring(whichItem)
        print(info)
        log.info(info)
        jassRemoveItem(whichItem)
    end
end
function AppTest.prototype.archiveTest(self)
    local key = "key值也占用存档空间,推荐短命名比如a1,B2,C34,以及中文"
    local av = ArchiveUtil:get(
        Player(0),
        key
    )
    if av then
        DisplayTimedTextToPlayer(
            GetLocalPlayer(),
            0,
            0,
            60,
            "从存档拉出的数据是:" .. tostring(av)
        )
        DisplayTimedTextToPlayer(
            GetLocalPlayer(),
            0,
            0,
            60,
            "从存档读对象表:" .. tostring(ArchiveUtil:get(
                Player(0),
                "我存个对象"
            )["套娃"].a)
        )
    else
        ArchiveUtil:set(
            Player(0),
            key,
            "哈哈我使劲存啊，把存档占满，不用白不用！！！！，布尔值可存0跟1以节省空间。我这里其实可以存超过64个长度的字符串啊 最大可存1.9W个字符"
        )
        ArchiveUtil:set(
            Player(0),
            "我存个对象",
            {["存个整数"] = 1, ["存个布尔"] = true, ["存个字符"] = "a", ["套娃"] = {a = "我是对象里的对象的套娃a数据"}}
        )
    end
end
function AppTest.prototype.httpJsonTest(self)
    se:playerChat(
        "tj",
        function()
            local result = JSON:stringify({a = {1, {b = 2}}})
            DebugUtil.showText((tostring(BaseUtil.getGameTime()) .. "[对象转Json字符串=]") .. tostring(result))
            result = JSON:parse("{\"a\":[1,{\"b\":2}]}")
            DebugUtil.showText((tostring(BaseUtil.getGameTime()) .. "[Json字符串转对象=]") .. tostring(result))
            print_r(result)
            local a = result.a
            DebugUtil.showText((tostring(BaseUtil.getGameTime()) .. "[Json字符串转对象a[0]=]") .. tostring(a[1]))
            DebugUtil.showText((tostring(BaseUtil.getGameTime()) .. "[Json字符串转对象a[1][\"b\"]=]") .. tostring(a[2].b))
        end
    )
end
____exports.default = AppTest
return ____exports
